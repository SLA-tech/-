# 淘宝店铺合规客服系统 — 技术开发文档

> 目标：为淘宝店铺提供**自动回复 + 敏感词过滤 + 合规引流**的综合系统，方便交付给 Cursor/开发者直接实现并部署。系统**必须合法合规**，禁止任何规避平台审查或制作/销售非法印章的行为。

---

## 1. 概要说明

- 系统名称：淘宝合规客服自动化系统（以下简称“系统”）
- 功能模块：
  1. 自动回复引擎（文字/图片循环、FAQ、欢迎语）
  2. 敏感词过滤与风险控制（检测、拦截、统计、标注）
  3. 合规引流模块（H5 中转页 + 企业微信接入 + 添加频率控制）
  4. 管理后台（话术编辑、词库编辑、统计面板、用户管理）
- 运行环境：Linux（推荐 Ubuntu 22.04）或 Docker 容器
- 目标部署：云主机（阿里云、腾讯云、AWS 等）或自托管服务器

---

## 2. 技术选型（推荐）

- 后端：Node.js (NestJS / Express) 或 Python (FastAPI)
- 前端：React（Vite）或 Next.js 用于管理后台与 H5 模板
- 数据库：MySQL / PostgreSQL（生产） + Redis（缓存/限流）
- 消息队列：RabbitMQ / Redis Streams（可选，用于异步任务）
- 企业微信：企业微信开放 API（企业微信客户端）
- 自动化对接淘宝：优先使用淘宝开放 API（若可用），若无则使用 PC 客服端自动化（UI 自动化作为备用）
- 部署：Docker + Docker Compose / Kubernetes

---

## 3. 系统架构

```
 用户（淘宝私信）
    ↓
 PC 自动化 / 淘宝 API 适配层
    ↓
 入口层（消息接收）
    ↓
 业务层：
   ├─ 自动回复引擎
   ├─ 敏感词检测引擎
   └─ 合规引流服务（H5 生成、企微接口）
    ↓
 数据持久层（MySQL） + 缓存（Redis）
    ↓
 管理后台（React）
```

说明：实际接入淘宝的通路按权限决定，若能使用淘宝官方 API（优先），否则使用 PC 自动化客户端（Selenium/AutoHotkey/WinAppDriver 等）作为适配层。

---

## 4. 数据模型（MySQL）

### 4.1 users（用户会话）

| 字段 | 类型 | 描述 |
|---|---:|---|
| id | bigint PK | 会话 ID |
| taobao_user_id | varchar(128) | 淘宝用户唯一 ID |
| current_status | varchar(32) | 会话状态（open/closed/blocked） |
| risk_level | tinyint | 风险等级（0-低，1-中，2-高） |
| created_at | datetime | 创建时间 |
| updated_at | datetime | 更新时间 |


### 4.2 messages（消息记录）

| 字段 | 类型 | 描述 |
|---|---:|---|
| id | bigint PK | 消息 ID |
| session_id | bigint FK | 会话 ID |
| direction | enum | inbound/outbound |
| content | text | 消息内容（纯文本） |
| content_type | varchar(16) | text/image/other |
| matched_rules | varchar(255) | 命中的规则/词（若有） |
| created_at | datetime | 时间 |


### 4.3 sensitive_words（敏感词库）

| 字段 | 类型 | 描述 |
|---|---:|---|
| id | int PK | ID |
| word | varchar(255) | 敏感词 |
| type | varchar(32) | 分类（legal/government/other） |
| severity | tinyint | 严重程度（1-10） |
| enabled | tinyint | 是否启用 |
| created_at | datetime | |


### 4.4 automated_templates（自动回复模板）

| 字段 | 类型 | 描述 |
|---|---:|---|
| id | int PK | ID |
| name | varchar(128) | 模板名 |
| content | text | 文本或图片引用（JSON） |
| loop_interval | int | 循环间隔（秒） |
| enabled | tinyint | 是否启用 |


### 4.5 audit_logs（操作/风控日志）

| 字段 | 类型 | 描述 |
|---|---:|---|
| id | bigint PK | ID |
| actor | varchar(128) | 操作人/系统 |
| action | varchar(255) | 操作描述 |
| meta | json | 额外信息 |
| created_at | datetime | 时间 |

---

## 5. 接口设计（REST API）

> 基本原则：所有外部请求走鉴权（JWT）; 管理后台所有 API 走 HTTPS。

### 5.1 接收消息（消息入口）

- **POST /api/v1/messages/inbound**
  - 输入：
    ```json
    {
      "taobao_user_id": "string",
      "content": "string",
      "content_type": "text|image",
      "source_meta": {...}
    }
    ```
  - 输出：{ status: ok }
  - 说明：该接口由淘宝适配层调用（自动化客户端或淘宝 API）。


### 5.2 发送消息（系统->用户）

- **POST /api/v1/messages/outbound**
  - 输入：
    ```json
    {
      "session_id": 123,
      "content": "...",
      "content_type": "text|image"
    }
    ```
  - 输出：{ status: queued }


### 5.3 管理敏感词

- **GET /api/v1/sensitive-words**
- **POST /api/v1/sensitive-words**
- **PUT /api/v1/sensitive-words/{id}**
- **DELETE /api/v1/sensitive-words/{id}**


### 5.4 管理模板

- **GET /api/v1/templates**
- **POST /api/v1/templates**
- **PUT /api/v1/templates/{id}**
- **DELETE /api/v1/templates/{id}**


### 5.5 会话管理

- **GET /api/v1/sessions**
- **GET /api/v1/sessions/{id}**
- **PUT /api/v1/sessions/{id}/close**
- **PUT /api/v1/sessions/{id}/block**


### 5.6 风控统计

- **GET /api/v1/reports/sensitive-summary?from=2025-01-01&to=2025-12-31**

---

## 6. 核心逻辑说明

### 6.1 自动回复引擎

1. 新消息到达 -> 查找是否存在匹配的 FAQ 模板（精确优先，后续为模糊匹配）
2. 若匹配且模板配置为自动回复 -> 将回复入队（outbound）并记录
3. 若无匹配 -> 根据会话状态触发欢迎语/默认回复或转人工
4. 循环模板：支持配置 `max_loops` 和 `loop_interval`，并基于 `session_id` 跟踪循环次数


### 6.2 敏感词检测引擎（实现细节）

- **词库管理**：字符串词条 + 正则表达式（同时支持简繁体、同义替换）
- **检测策略**：优先做归一化（去空格、大小写、同义替换、中文全角半角统一）
- **匹配流程**：
  1. 对短句使用 Aho-Corasick 自动机（高效批量匹配）
  2. 对复杂规则使用正则（例如身份证、机构名模糊匹配）
- **拦截策略**：
  - 严重级别 >= X（配置化） -> 立即拦截并中断会话
  - 中等级别 -> 提示改写并记录
  - 低级别 -> 仅记录，不阻断
- **误报控制**：支持白名单（自定义短语）和上下文判定（例如“我有公章” vs “如何辨别公章真假”）


### 6.3 合规引流流程（H5 转发）

1. 用户触发“获取详细信息” -> 系统发送 H5 链接而非直接个人微信号
2. H5 页面放置企业信息、资质与企业微信二维码按钮
3. 用户在 H5 点击“添加客服” -> 跳转到企业微信小程序或打开企微添加页
4. 系统在会话内记录是否发送过二维码（1 小时内只发一次）

说明：使用 H5 中转可以显著降低被微信/平台频繁封号的风险。

---

## 7. 企业微信集成（合规接入）

- 使用企业微信开放平台的客服/接待接口（参考企业微信官方文档）
- 企微接入步骤：
  1. 注册并创建企业微信账号，配置安全域名与回调 URL
  2. 获取 `CorpID`、`Secret`、`AgentId`
  3. 使用 OAuth / access_token 机制进行鉴权
  4. 配置消息发送（模板消息 / 客服消息）
  5. 实现企业微信的 Webhook 回调，处理用户在企微的消息

安全建议：使用企业微信提供的接口（不要通过个人微信号做自动化引流）。

---

## 8. PC 自动化适配层（当淘宝 API 不可用时）

> 说明：优先使用官方 API；若必须自动化 PC 客服客户端，请参考下述做法并注意频率控制，不要做绕过风控的行为。

- 技术选型：Selenium + WinAppDriver / pywinauto / AutoHotkey（Windows 环境）
- 功能：监听新私信 -> 解析消息 -> 调用本地 HTTP 接口（/messages/inbound） -> 系统处理 -> 从 outbound 队列取消息 -> 在客服窗口回复
- 防风控策略：随机延时、模拟人工行为、限制每天并发会话数

---

## 9. 管理后台（功能清单）

- 登录/权限管理（管理员 / 客服 / 审计）
- 敏感词管理（新增/编辑/启用/禁用/导入/导出）
- 自动回复模板管理（文本 + 图片）
- 会话列表与查看（包含消息全文）
- 风险统计面板（敏感触发图表、TOP 触发词）
- 日志与审计（操作日志）
- 系统配置（限流阈值、拦截阈值、H5 链接）

---

## 10. 配置与运维

- 日志：使用集中式日志（ELK / Loki + Grafana）
- 报警：敏感触发超过阈值 -> 通知运维（邮件/钉钉/企业微信）
- 备份：数据库每日备份，保留 30 天
- 灾备：关键服务冗余，Redis 持久化

---

## 11. 安全与合规注意事项（必须遵守）

**严禁**为任何非法/敏感业务提供技术支持，包括但不限于：
- 规避平台检测、屏蔽敏感词以骗审
- 制作/销售国家机关、军队、公安等公章或伪造证件
- 批量拉人/群控/滥加好友以规避风控

系统设计必须记录、阻断并上报疑似违规的会话。若出现明确违法请求（如伪造印章），系统应自动：
1. 拦截并停止进一步沟通
2. 回复告知无法提供此类服务
3. 将会话打上高风险并在后台标注

---

## 12. 测试用例

- 新用户首次会话 -> 应触发欢迎语
- 用户发送“价格” -> FAQ 模板命中并自动回复
- 用户发送敏感词（如“办证”）-> 系统自动提示并记录
- 用户连续 3 次发送高危词 -> 系统关闭会话并标注风险
- H5 二次发送控制：同一用户 1 小时内不能再次收到二维码

---

## 13. 交付产物（给 Cursor）

1. 源代码（后端 + 前端）
2. Docker Compose 部署脚本
3. README（部署步骤、环境变量、DB 迁移）
4. 敏感词基础词库（CSV）
5. 自动回复模板（示例）
6. H5 页面静态模板
7. API 文档（OpenAPI / Swagger）

---

## 14. 参考实现要点（开发者提示）

- 敏感词匹配：推荐使用 Aho-Corasick 库（高效批量匹配），对中文做分词与归一化
- 正则规则：对复杂机构名/身份证号/联系方式使用正则，并限速匹配以免误报
- 队列机制：outbound 消息通过队列发送，保证不丢消息且便于重试
- 限流：Redis 实现每用户/每 IP 的发送限流（如每用户每小时发送二维码上限）
- 审计：所有拦截动作写入 audit_logs，便于客服与法务复查

---

## 15. 示例话术（合规示例）

- 欢迎语：
  > 您好，欢迎光临！如需了解产品详情，请查看商品详情页或回复“人工客服”。

- 敏感阻断回复：
  > 抱歉，我们无法提供涉及违法或违规的服务，请使用合法合规的描述或咨询当地执法机构。

- 引流到企微（H5）：
  > 如需详细沟通，请访问我们的客服页面：<H5 链接>，页面内可一键添加企业微信客服。

---

## 16. 项目排期（可调整）

- 需求确认：1 天
- 后端 + DB：3 天
- 管理后台：2 天
- PC 适配（若需要）：2 天
- 企业微信集成 + H5：1 天
- 测试与上线：1-2 天

---

## 17. 估算报价（供参考）

- 基础版（自动回复 + 敏感词 + H5）：¥3,000 — ¥5,000
- 综合版（管理后台 + 审计 + 企业微信深度集成）：¥5,000 — ¥9,000
- 定制化高可用版（集群、日志、SLA）：¥10,000+

---

## 18. 附录：敏感词示例（仅作分类示范，实际词库需法务与运营审核）

- 高危：军队、公检法、国家机关章、伪造证件、办证流程等
- 中危：公章、假章、办证、办证件、代办
- 低危：模糊表达的业务相关词

> **注意**：词库须交由合规人员复核，避免误判或误封。

---

## 19. 联系与交付说明

- 开发者交付时请提供：代码仓库地址、Docker 镜像、数据库迁移脚本、部署指南
- 在交付后建议至少 7 天上线监控期，观察敏感触发率并调整规则

---

**文档结束 — 如需我把本份文档导出为 Markdown 文件或生成部署脚本、OpenAPI 文档、或直接生成 Cursor 可执行的代码仓库结构，我可以继续生成。**

